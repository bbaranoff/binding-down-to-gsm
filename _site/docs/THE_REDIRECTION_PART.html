<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>The redirection part | binding-down-to-gsm</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="The redirection part" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Show how to fallback from 4G LTE or 5G NSA to 2G EDGE local network" />
<meta property="og:description" content="Show how to fallback from 4G LTE or 5G NSA to 2G EDGE local network" />
<link rel="canonical" href="http://localhost:4000/docs/THE_REDIRECTION_PART.html" />
<meta property="og:url" content="http://localhost:4000/docs/THE_REDIRECTION_PART.html" />
<meta property="og:site_name" content="binding-down-to-gsm" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="The redirection part" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Show how to fallback from 4G LTE or 5G NSA to 2G EDGE local network","headline":"The redirection part","url":"http://localhost:4000/docs/THE_REDIRECTION_PART.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=317108e2fe1d0841ab11d35e0615361844025415">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">binding-down-to-gsm</a></h1>
      

      <h1 id="the-redirection-part">The redirection part</h1>

<p>Binding down to unsafe network</p>

<hr />

<!-- MarkdownTOC -->

<ul>
  <li><a href="#getting-started">Getting started</a></li>
</ul>

<!-- /MarkdownTOC -->

<h2 id="getting-started">Getting started</h2>

<p>Below is an English‐language explanation of how the UE is forced to fall back to a GERAN (2G/EDGE) cell—specifically because we broadcast a fake Tracking Area Code (TAC) that is one higher or one lower than the “real” TAC, and because the <code class="language-plaintext highlighter-rouge">is_csfb</code> flag is set to true inside the <code class="language-plaintext highlighter-rouge">send_connection_release()</code> function. The snippet in question lives in <strong><code class="language-plaintext highlighter-rouge">rrc_ue.cc</code></strong> under <strong><code class="language-plaintext highlighter-rouge">void rrc::ue::send_connection_release()</code></strong>; it looks like this:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">rrc</span><span class="o">::</span><span class="n">ue</span><span class="o">::</span><span class="n">send_connection_release</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">dl_dcch_msg_s</span> <span class="n">dl_dcch_msg</span><span class="p">;</span>
  <span class="k">auto</span><span class="o">&amp;</span>         <span class="n">rrc_release</span>          <span class="o">=</span> <span class="n">dl_dcch_msg</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">set_c1</span><span class="p">().</span><span class="n">set_rrc_conn_release</span><span class="p">();</span>
  <span class="n">rrc_release</span><span class="p">.</span><span class="n">rrc_transaction_id</span>     <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)((</span><span class="n">transaction_id</span><span class="o">++</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>
  <span class="n">rrc_conn_release_r8_ies_s</span><span class="o">&amp;</span> <span class="n">rel_ies</span> <span class="o">=</span> <span class="n">rrc_release</span><span class="p">.</span><span class="n">crit_exts</span><span class="p">.</span><span class="n">set_c1</span><span class="p">().</span><span class="n">set_rrc_conn_release_r8</span><span class="p">();</span>
  <span class="n">rel_ies</span><span class="p">.</span><span class="n">release_cause</span>              <span class="o">=</span> <span class="n">release_cause_e</span><span class="o">::</span><span class="n">other</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">is_csfb</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">sib7</span><span class="p">.</span><span class="n">carrier_freqs_info_list</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">rel_ies</span><span class="p">.</span><span class="n">redirected_carrier_info_present</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">rel_ies</span><span class="p">.</span><span class="n">redirected_carrier_info</span><span class="p">.</span><span class="n">set_geran</span><span class="p">();</span>
      <span class="n">rel_ies</span><span class="p">.</span><span class="n">redirected_carrier_info</span><span class="p">.</span><span class="n">geran</span><span class="p">()</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">sib7</span><span class="p">.</span><span class="n">carrier_freqs_info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">carrier_freqs</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">rel_ies</span><span class="p">.</span><span class="n">redirected_carrier_info_present</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">octet_str</span><span class="p">;</span>
  <span class="n">send_dl_dcch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dl_dcch_msg</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">octet_str</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="what-this-code-does-">What this code does ?</h2>

<ol>
  <li>
    <p><strong>Context: why <code class="language-plaintext highlighter-rouge">send_connection_release()</code> is called</strong></p>

    <ul>
      <li>In a standard LTE eNodeB‐UE RRC procedure, the network can decide to tear down (release) an RRC connection by sending an <strong>RRC Connection Release</strong> message.</li>
      <li>In our “interception 2G” scenario, we first lure the UE onto a cell whose TAC is artificially set to something like “original TAC + 1” (or “original TAC – 1”). Because the UE sees a new TAC that doesn’t match its currently registered TAC, it performs a <strong>Tracking Area Update</strong> and establishes an RRC Connection on that fake cell.</li>
      <li>As soon as the UE is RRC‐connected to that fake cell (with TAC ±1), the eNodeB calls <code class="language-plaintext highlighter-rouge">send_connection_release()</code>. In other words, the UE is now camped on our fake LTE cell, and we want to immediately force it off LTE and onto GERAN.</li>
    </ul>
  </li>
  <li>
    <p><strong>Breaking down the function</strong></p>

    <ul>
      <li>We build a new downlink DCCH (Dedicated Control Channel) message of type <strong>RRC Connection Release</strong>.</li>
      <li>We assign a transaction ID (<code class="language-plaintext highlighter-rouge">rrc_transaction_id</code>) in the normal way (just cycling through 0…3).</li>
      <li>We set <code class="language-plaintext highlighter-rouge">release_cause = other</code> because “other” is a generic cause for releasing the connection.</li>
    </ul>
  </li>
  <li>
    <p><strong>The crucial <code class="language-plaintext highlighter-rouge">if (is_csfb)</code> block</strong></p>

    <ul>
      <li>
        <p>The member variable <code class="language-plaintext highlighter-rouge">is_csfb</code> was set to <code class="language-plaintext highlighter-rouge">true</code> earlier (in <code class="language-plaintext highlighter-rouge">rrc_ue.h</code>). Because of that, this <code class="language-plaintext highlighter-rouge">if</code> always succeeds. If it had been <code class="language-plaintext highlighter-rouge">false</code>, the code inside would be skipped, and the RRC Release would carry <strong>no redirection info</strong>—the UE would simply go back to idle on LTE.</p>
      </li>
      <li>
        <p>Since <code class="language-plaintext highlighter-rouge">is_csfb == true</code>, we check whether <code class="language-plaintext highlighter-rouge">parent-&gt;sib7.carrier_freqs_info_list.size() &gt; 0</code>. In practice, <code class="language-plaintext highlighter-rouge">sib7.carrier_freqs_info_list[0].carrier_freqs</code> is a list of GERAN frequencies that we broadcast in the system information (SIB7) of our fake LTE cell. We typically populate that list with one or more GSM/EDGE ARFCNs (e.g., BCCH channels).</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="why-this-makes-the-ue-fall-back-to-2g-for-about-one-minute">Why this makes the UE fall back to 2G for about one minute</h2>

<ol>
  <li>
    <p><strong>Step 1: UE camps on fake LTE cell (TAC ± 1)</strong></p>

    <ul>
      <li>The UE was originally registered on a “real” LTE cell (TAC = X). We broadcast a second cell with TAC = X + 1 (or X – 1). Because the Tracking Area Code no longer matches, the UE performs a new RRC connection attachment to that fake cell. It’s now in LTE RRC Connected state on our interception cell.</li>
    </ul>
  </li>
  <li>
    <p><strong>Step 2: RRC Connection Release + CSFB redirect</strong></p>

    <ul>
      <li>
        <p>Immediately, the eNodeB runs <code class="language-plaintext highlighter-rouge">send_connection_release()</code>. Because <code class="language-plaintext highlighter-rouge">is_csfb == true</code>, the UE receives:</p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RRC Connection Release
  • release_cause = other
  • redirected_carrier_info_present = true
    – type = GERAN
    – list of GERAN frequencies (from SIB7)
</code></pre></div>        </div>
      </li>
      <li>
        <p>LTE RRC dictates that as soon as an RRC Connection Release with redirection is received, the UE must tear down its LTE RRC session <strong>and</strong> immediately perform a cell reselection to the given 2G ARFCN(s).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Step 3: UE camps on GERAN (Interception 2G)</strong></p>

    <ul>
      <li>The UE tunes to the indicated BCCH frequency (e.g., an ARFCN in the GSM 900/1800 band). It performs a normal “GSM Attach” or “Location Update” on that cell. Because our IMSI‐catcher is pretending to be a legal GSM BTS, the UE finishes its location update and thinks it is “registered” on 2G.</li>
    </ul>
  </li>
  <li>
    <p><strong>Step 4: UE gives up after ≈ 60 seconds</strong></p>

    <ul>
      <li>After roughly one minute of “stuck in 2G without any real service,” the UE automatically decides that this 2G cell is useless. Its firmware triggers a “cell reselection” back to the strongest LTE cell available (which, in our testbed, is still the legitimate operator’s LTE cell).</li>
      <li>At that point, the UE re‐attaches to LTE (or resumes its previous EPS context) and resumes normal data/VoLTE usage.</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="summary">Summary</h2>

<ul>
  <li>
    <p>We broadcast a second LTE cell whose Tracking Area Code (TAC) is set to “original_TAC ± 1.” Because the UE sees a mismatched TAC, it camps on our fake LTE cell in <strong>RRC Connected</strong> state.</p>
  </li>
  <li>
    <p>In the <code class="language-plaintext highlighter-rouge">send_connection_release()</code> function of <code class="language-plaintext highlighter-rouge">rrc_ue.cc</code>, we have forced <code class="language-plaintext highlighter-rouge">is_csfb = true</code> (in <code class="language-plaintext highlighter-rouge">rrc_ue.h</code>). As soon as the UE attaches to our fake cell, the code builds an <strong>RRC Connection Release</strong> message containing:</p>

    <ol>
      <li><code class="language-plaintext highlighter-rouge">release_cause = other</code></li>
      <li><code class="language-plaintext highlighter-rouge">redirected_carrier_info_present = true</code></li>
      <li>A <strong>GERAN</strong> redirection IE listing one or more 2G/EDGE frequencies (pulled from <code class="language-plaintext highlighter-rouge">parent-&gt;sib7.carrier_freqs_info_list[0]</code>).</li>
    </ol>
  </li>
  <li>
    <p>When the UE receives that RRC release with redirection, it immediately tears down LTE and camps onto the specified GSM/EDGE frequency.</p>
  </li>
  <li>
    <p>Because our fake 2G cell does not provide a genuine SGSN/MSC, the UE’s 2G‐layer timers expire after about one minute, and the phone gives up on the fake 2G cell and re‐selects back to the real LTE network.</p>
  </li>
  <li>
    <p>In short, the combination of:</p>

    <ol>
      <li>broadcasting TAC ± 1 to trick the UE into RRC‐connecting to our cell,</li>
      <li>setting <code class="language-plaintext highlighter-rouge">is_csfb = true</code> so that <strong>every</strong> RRC Connection Release includes a GERAN redirect,
allows us to force the UE into 2G for roughly 60 seconds before it finally realizes “no real service here” and returns to LTE.</li>
    </ol>
  </li>
</ul>

<p>This is why, in an interception scenario, the UE ends up on the fake 2G network for about one minute: it’s following the standard CSFB procedure (driven by <code class="language-plaintext highlighter-rouge">is_csfb = true</code> in <code class="language-plaintext highlighter-rouge">send_connection_release()</code>), but the interceptor never completes a valid 2G attach/Authentication/MSC handover.</p>

<pre><code class="language-danger">After its internal 2G timers time out (≈ 60 s), the UE reverts to LTE.
</code></pre>



      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
  </body>
</html>

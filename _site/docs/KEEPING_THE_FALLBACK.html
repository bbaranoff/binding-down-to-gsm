<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Keeping the fallback | binding-down-to-gsm</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Keeping the fallback" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Show how to fallback from 4G LTE or 5G NSA to 2G EDGE local network" />
<meta property="og:description" content="Show how to fallback from 4G LTE or 5G NSA to 2G EDGE local network" />
<link rel="canonical" href="http://localhost:4000/docs/KEEPING_THE_FALLBACK.html" />
<meta property="og:url" content="http://localhost:4000/docs/KEEPING_THE_FALLBACK.html" />
<meta property="og:site_name" content="binding-down-to-gsm" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Keeping the fallback" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Show how to fallback from 4G LTE or 5G NSA to 2G EDGE local network","headline":"Keeping the fallback","url":"http://localhost:4000/docs/KEEPING_THE_FALLBACK.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=317108e2fe1d0841ab11d35e0615361844025415">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">binding-down-to-gsm</a></h1>
      

      <h1 id="keeping-the-fallback">Keeping the fallback</h1>

<p>Below is a step‐by‐step explanation of what happens when you redirect a phone twice to the same ARFCN, first advertising a “real” operator MCC/MNC (so the UE attaches normally), then advertising MCC = 001, MNC = 01 (PLMN 001–01). In particular, we’ll see why the UE stays camped on 2G 001–01 (even though that PLMN is “not allowed” by its SIM) and never immediately falls back to 4G.</p>

<hr />

<h2 id="1-scenario-summary">1. Scenario summary</h2>

<ol>
  <li>
    <p><strong>First redirection</strong>:</p>

    <ul>
      <li>You run your fake eNodeB on a given GSM ARFCN (e.g. BCCH = ARFCN 871).</li>
      <li>In <code class="language-plaintext highlighter-rouge">send_connection_release()</code>, you set <code class="language-plaintext highlighter-rouge">is_csfb = true</code> and include in the RRC Release that same ARFCN under a “real” operator PLMN (call it MCC/MNC = AAA–BBB).</li>
      <li>The UE receives “RRC Release + redirect to GSM ARFCN 871 under PLMN AAA–BBB,” tears down LTE and camps on that 2G cell in PLMN AAA–BBB. Because AAA–BBB is a valid Home (or equivalent) PLMN, the UE attaches successfully in 2G.</li>
    </ul>
  </li>
  <li>
    <p><strong>Second redirection (same ARFCN, but now PLMN = 001–01)</strong>:</p>

    <ul>
      <li>You leave the same GSM BCCH ARFCN 871 on air, but you change the cell’s MCC/MNC to 001–01. In other words, everything about that 2G cell (ARFCN, BSIC, SIB7 neighbor lists, etc.) is identical—only the PLMN now reads “001–01” instead of “AAA–BBB.”</li>
      <li>The UE, still camped on 2G AAA–BBB or coming from LTE, gets redirected again via LTE RRC Release → it tears down LTE and camps on 2G ARFCN 871 under MCC/MNC 001–01.</li>
      <li>Now the UE performs a normal 2G Location Update, but the fake 2G BTS (IMSI‐catcher) replies “LAU Reject: PLMN not allowed.”</li>
    </ul>
  </li>
</ol>

<p>At this point, the UE is sitting on a 2G cell broadcasting PLMN 001–01—which is not in its allowed PLMN list—yet it does <strong>not</strong> immediately go back to LTE. Why?</p>

<hr />

<h2 id="2-how-the-ue-decides-which-plmn-to-camp-on-in-2g">2. How the UE decides which PLMN to camp on in 2G</h2>

<h3 id="21-2g-cell-selection--reselection-basics">2.1. 2G cell selection / reselection basics</h3>

<p>When a UE is in Idle mode (RRC IDLE on LTE or Idle on 2G), it continually looks for the “best” cell according to these priorities (per 3GPP TS 23.122 and TS 36.304):</p>

<ol>
  <li>
    <p><strong>Highest‐priority PLMN</strong>:</p>

    <ul>
      <li>The UE has a list of PLMNs in its USIM—starting with the Home PLMN (HPLMN), then any Equivalent PLMNs (EF-PLMN), then the list of “Allowed” PLMNs (if it’s roaming).</li>
      <li>It will prefer to camp on a carrier whose broadcast PLMN matches one of those, in priority order.</li>
    </ul>
  </li>
  <li>
    <p><strong>Cell‐ranking inside a given PLMN</strong>:</p>

    <ul>
      <li>If multiple cells broadcast the same PLMN, the UE uses “cell reselection” criteria (signal‐strength thresholds and ranking parameters) to choose which one it likes best.</li>
      <li>If a cell’s PLMN is on the SIM’s <strong>Forbidden PLMN</strong> (FPLMN) list, the UE will normally treat that cell as “barred” and not camp on it—unless it was forced by RRC redirection.</li>
    </ul>
  </li>
</ol>

<h3 id="22-forced-rrc-redirection-overrides-normal-camp-rules">2.2. Forced RRC redirection overrides normal camp rules</h3>

<ul>
  <li>When an LTE eNodeB sends <strong>“RRC Connection Release with redirected_carrier_info → GERAN, PLMN = 001–01, ARFCN = 871”</strong>, the UE immediately <strong>aborts</strong> whatever it was about to do in LTE (or 2G) and tunes to GERAN ARFCN 871 under PLMN 001–01.</li>
  <li>
    <p>Even if PLMN 001–01 is not in the UE’s allowed list, the UE obeys the RRC redirection first. In other words:</p>

    <ol>
      <li><strong>RRC release</strong> → UE is told “drop your LTE RRC and go camp on that 2G BCCH (ARFCN 871, MCC/MNC 001–01).”</li>
      <li>UE tunes to 2G ARFCN 871, decodes SIBs, sees PLMN 001–01, and camps—even though that PLMN is “forbidden” by its SIM. Because RRC redirection has <strong>higher priority</strong>, the UE must at least attempt to attach.</li>
    </ol>
  </li>
</ul>

<hr />

<h2 id="3-what-happens-when-the-ue-sees-plmn-not-allowed-in-2g">3. What happens when the UE sees “PLMN not allowed” in 2G</h2>

<ol>
  <li>
    <p><strong>Location Update procedure</strong></p>

    <ul>
      <li>As soon as the UE camps on ARFCN 871 under PLMN 001–01, it initiates a <strong>GSM Location Update</strong> (LAU) to the IMSI-catcher (or “fake MSC”).</li>
      <li>The fake MSC (or SGSN if packet‐switched) can respond with <strong>LAU Reject, cause = “PLMN not allowed.”</strong> This is the standard GSM cause code for “the UE is not allowed to register on this PLMN.”</li>
    </ul>
  </li>
  <li>
    <p><strong>UE’s reaction to “LAU Reject: PLMN not allowed”</strong></p>

    <ul>
      <li>
        <p>Upon receiving that reject, the UE does the following (per TS 04.08 / TS 22.010):</p>

        <ul>
          <li>It knows its SIM/USIM does <strong>not</strong> allow registration on 001–01, so it adds <strong>001–01</strong> to its <strong>Forbidden PLMN (FPLMN) list</strong>—meaning: “don’t try this PLMN again until after a timer (T3245) expires.”</li>
          <li>However, it stays physically camped on that BCCH frequency (ARFCN 871) until it finds another acceptable cell, because to leave a 2G RACH/BCCH behind, it must find an alternate “better” cell first.</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="4-why-the-ue-does-not-immediately-fall-back-to-4g">4. Why the UE does <em>not</em> immediately fall back to 4G</h2>

<p>Once the UE has marked PLMN 001–01 as forbidden, you might think it would simply go look for LTE again—after all, its SIM says “I’m not allowed on 001–01, so I’ll reselect back to LTE.” But in practice, it usually does <strong>not</strong> instantaneously re‐camp to LTE, for two reasons:</p>

<h3 id="41-no-lte-neighbor-info-or-lte-cell-absent">4.1. No LTE neighbor info (or LTE cell absent)</h3>

<ul>
  <li>
    <p>When you broadcast that fake 2G cell on ARFCN 871, you typically only advertise <strong>GERAN frequencies</strong> (and your fake PLMN 001–01). You do <strong>not</strong> broadcast any E-UTRAN neighbor information (no SIB7 for LTE, no SIB19, etc.) on that BCCH.</p>
  </li>
  <li>
    <p>A UE in idle on 2G waits for periodic “cell reselection” checks (every few hundred ms). It will consider these in order:</p>

    <ol>
      <li>“Is there a higher‐priority 2G or 3G cell whose PLMN is allowed?”</li>
      <li>“Is there a same‐priority 2G/3G cell I like better?”</li>
      <li>“Is there any 3G/4G (UTRAN/E-UTRAN) neighbor in the SIBs I can reselect to?”</li>
    </ol>
  </li>
  <li>Because your fake 2G BCCH only lists itself (ARFCN 871, PLMN 001–01) and no LTE neighbor, the UE’s reselection algorithm never “sees” any E-UTRAN cell it could go to. Even if a real LTE cell from its operator is physically close by, the UE doesn’t know about it—because no neighbor‐list IE pointed to it.</li>
  <li>Therefore, from the UE’s point of view:</li>
</ul>

<blockquote>
  <p>[!TIP]
“I’m camped on ARFCN 871 (2G), PLMN 001–01 (which I just marked forbidden), but I have no other candidate cell broadcasts in my BCCH. I must stay here until I find an alternative cell.”
It will not hop back to LTE “by itself” unless it actually sees a higher‐priority (allowed) cell in the same BCCH’s neighbor‐list or it runs out of reacquisition timers entirely.</p>
</blockquote>

<h3 id="42-forbidden-plmn--barred-for-some-time-but-not-immediate-reselect">4.2. Forbidden PLMN → barred for some time, but not immediate reselect</h3>

<ul>
  <li>After “PLMN not allowed,” the UE writes 001–01 into its <strong>Local FPLMN</strong> list for a duration T3245 (usually several minutes).</li>
  <li>While that PLMN is in the FPLMN, the UE treats any 2G/3G cell broadcasting 001–01 as “barred” for reselection. In a normal scenario, it would immediately drop that barred cell and look for another allowed cell (e.g. another 2G PLMN or 3G or LTE).</li>
  <li>
    <p>But because <strong>no other cells</strong> are visible in its immediate vicinity (recall—your fake BCCH does not advertise a valid LTE neighbor), it has nowhere else to go. In other words:</p>

    <ul>
      <li>It does <strong>not</strong> say “I’ll drop 2G and go register on LTE,” because the 2G BCCH is still strongest—so it stays camped.</li>
      <li>It does <strong>not</strong> see any “allowed” PLMN on that frequency, because the only PLMN is 001–01 (now forbidden).</li>
      <li>It does <strong>not</strong> see any 4G neighbor IE, because your fake 2G cell never told it about LTE.</li>
    </ul>
  </li>
</ul>

<p>According to 3GPP TS 23.122 (for GSM/UTRAN cell selection) and TS 36.304 (for E-UTRAN), a barred PLMN cannot be reselected on that RAT, but the UE still must await the next “cell search” window. If it finds nothing else there, it remains stuck, nominally, on the barred BCCH until it detects a stronger/allowed candidate—then it finally hops to that. In practice:</p>

<ol>
  <li><strong>PLMN 001–01 is barred</strong> → the UE marks ARFCN 871/001–01 as ineligible for camp.</li>
  <li><strong>Immediately afterward</strong>, no other BCCH is strong enough (or none was advertised), so the UE stays on ARFCN 871 (even though it’s barred) because the reselection algorithm needs an “actual replacement” before leaving.</li>
  <li><strong>Without LTE neighbor info</strong>, the UE never realizes “hey, there’s a valid LTE cell on frequency X” → so it never triggers a 4G reselection event.</li>
  <li>Over time (T3245 expires), the UE might remove 001–01 from FPLMN and try 2G 001–01 again—only to get “PLMN not allowed” again. Only once it sees a real LTE neighbor or some other allowed 2G/3G PLMN will it move.</li>
</ol>

<hr />

<h2 id="5-putting-it-all-together">5. Putting it all together</h2>

<ul>
  <li><strong>First redirection (PLMN AAA–BBB)</strong> → UE obeys RRC Release, camps on 2G ARFCN 871/AAA–BBB, attaches normally because AAA–BBB is in its allowed list.</li>
  <li>
    <p><strong>Second redirection (PLMN 001–01)</strong> → UE obeys RRC Release again, camps on 2G ARFCN 871/001–01, then sends LAU. Network replies “PLMN not allowed.” UE marks 001–01 as forbidden but remains physically on ARFCN 871 because:</p>

    <ol>
      <li>It was forced there by RRC, ignoring normal “don’t camp on forbidden” immediately.</li>
      <li>No other cell (including any real LTE) was advertised in that 2G BCCH’s neighbor lists.</li>
      <li>The UE’s cell‐reselection logic must find a strictly “better” allowed cell before vacating ARFCN 871—hence it stays there until such a cell appears.</li>
    </ol>
  </li>
</ul>

<pre><code class="language-tip">Thus, you see the UE stay on 2G 001–01 for several seconds (or even minutes, until it finds a different allowed PLMN / RAT). It does **not** “refall back to 4G” immediately, because from the UE’s perspective there simply isn’t any other *advertised* cell to go to—only that one forbidden‐PLMN 2G cell, which it can’t deregister from until it finds an alternative.
</code></pre>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
  </body>
</html>
